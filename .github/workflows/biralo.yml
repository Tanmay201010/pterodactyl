name: VPS Workflow

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # Runs every 6 hours

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download previous backup (if any)
        uses: actions/download-artifact@v4
        with:
          name: vps-backup
          path: ./backup
        continue-on-error: true

      - name: Restore previous backup
        run: |
          if [ -f ./backup/backup.tar.gz ]; then
            echo "Restoring previous backup..."
            sudo tar -xzf ./backup/backup.tar.gz -C /
          fi

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscaled --tun=userspace-networking --socks5-server=localhost:1055 &
          sleep 5
          sudo tailscale up --authkey=${{ secrets.TS_AUTHKEY }} --hostname=gh-vps --accept-dns=true

            - name: Enable Tailscale Funnel
        run: |
          echo "Enabling Funnel on port 3000..."
          # start a demo web server so funnel has something to serve
          nohup python3 -m http.server 3000 >/dev/null 2>&1 &
          sleep 3
          sudo tailscale funnel --yes 3000
          echo "âœ… Funnel is active on port 3000"
          tailscale funnel status

      - name: Show Tailscale IP and Funnel info
        run: |
          echo "Tailscale IP:"
          cat tailscale_ip.txt
          echo "Funnel running on port 3000"

      - name: Setup tmate (background SSH)
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true
          detach: true

      - name: Keep VPS alive (6h)
        run: sleep 21600

      - name: Create backup
        run: |
          echo "Creating backup of home, etc, and tailscale state..."
          sudo tar -czf backup.tar.gz \
            /home/biralo \
            /etc \
            /var/lib/tailscale/tailscaled.state || true

      - name: Upload VPS backup artifact
        uses: actions/upload-artifact@v4
        with:
          name: vps-backup
          path: backup.tar.gz
